name: Run Terraform Checkov Scan
id: run-terraform-checkov-scan
description: Runs a scan of terraform with Checkov

inputs:
  terraform_root_path:
    description: 'Relative path to root of Terraform code (usually ./iac)'
    required: true

runs:
  using: composite
  steps:
    - name: Terraform Show Plan to Json
      id: tf-plan-json-action
      shell: bash
      working-directory: ${{ inputs.terraform_root_path }}
      run: |
        terraform show -json tfplan | jq '.' > tfplan.json

    - name: Setup Checkov
      uses: ./.github/actions/setup-checkov
      with:
        working_directory: ${{ inputs.terraform_root_path }}
        config_source_path: ${{ github.action_path }}/.checkov.yml

    - name: Terraform Scan with Checkov
      id: checkov-scan-action
      uses: bridgecrewio/checkov-action@v12
      with:
        config_file: ${{ inputs.terraform_root_path }}/.checkov.yml

    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      
      # Results are generated only on a success or failure
      # this is required since GitHub by default won't run the next step
      # when the previous one has failed. Security checks that do not pass will 'fail'.
      # An alternative is to add `continue-on-error: true` to the previous step
      # Or 'soft_fail: true' to checkov.
      if: success() || failure()
      with:
        category: iac
        sarif_file: ${{ inputs.terraform_root_path }}/results.sarif