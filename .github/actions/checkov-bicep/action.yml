# filepath: /.github/actions/checkov-bicep/action.yml
name: 'Bicep Scan (Checkov)'
description: 'Builds Bicep to ARM JSON and scans with Checkov'

inputs:
  bicep_file_path:
    description: 'Path to the main Bicep file'
    required: true
  bicep_root_path:
    description: 'Root path for Bicep files and output artifacts'
    required: true
  # compiled_arm_path: # Optional: Use if validate step already built the JSON
  #   description: 'Path to the pre-compiled ARM template JSON'
  #   required: false
  #   default: ''

runs:
  using: "composite"
  steps:
    - name: Build Bicep to ARM JSON
      shell: bash
      working-directory: ${{ inputs.bicep_root_path }}
      run: |
        echo "Building Bicep to ARM JSON..."
        az bicep build --file ${{ inputs.bicep_file_path }} --outfile compiled.arm.json
        echo "COMPILED_ARM_JSON=${{ inputs.bicep_root_path }}/compiled.arm.json" >> $GITHUB_ENV

    - name: Setup Checkov
      uses: ./.github/actions/setup-checkov
      with:
        working_directory: ${{ inputs.bicep_root_path }}
        config_source_path: ${{ github.action_path }}/.checkov.yml

    - name: Run Checkov Scan
      id: checkov-scan-action
      uses: bridgecrewio/checkov-action@v12
      with:
        file: ${{ inputs.bicep_root_path }}/compiled.arm.json
        repo_root_for_plan_enrichment: ${{ inputs.bicep_root_path }}
        download_external_modules: true
        config_file: ${{ inputs.bicep_root_path }}/.checkov.yml

    - name: Upload SARIF file
      if: success() || failure()
      uses: github/codeql-action/upload-sarif@v3
      with:
        category: bicep-iac
        sarif_file: ${{ inputs.bicep_root_path }}/results.sarif
